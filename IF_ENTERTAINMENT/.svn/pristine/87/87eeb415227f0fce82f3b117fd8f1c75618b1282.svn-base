<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<script src="${pageContext.request.contextPath }/resources/sweetAlertCustom/sweetAlertCustom.js"></script>


<div class="central-meta OrderIssue">
	<h1 class="create-post">주문내역</h1>
	<div class="cart-sec">
		<table class="table table-responsive OrderIssue-table">
			<tr>
				<th>주문번호</th>
				<th>상품</th>
				<th>총 수량</th>
				<th>총 결제금액</th>
				<th>상태</th>
			</tr>
			<c:set value="${pagingVO.dataList }" var="myOrderList" />
			<c:choose>
				<c:when test="${empty myOrderList }">
					<tr>
						<td>주문내역이 존재하지 않습니다.</td>
					</tr>
				</c:when>
				<c:otherwise>
					<c:forEach items="${myOrderList }" var="myOrder">
						<tr>
							<td class="orderno-box">
								<span class="woocommerce-Price-amount amount">
									${myOrder.orderNo }
									<a class="detail" data-orderNo="${myOrder.orderNo }">상세보기</a>
								</span>
							</td>
							<td>
								<div class="cart-avatar issu-imgbox goods">
									<img src="${myOrder.goodsThumbnail }" alt="">
								</div>
								<div class="cart-meta issue-pro-con goods" data-goodsNo="${myOrder.goodsNo}">
									<span class="issue-pro-artist">${myOrder.goodsArtist }</span>
									<span class="issue-pro-title">${myOrder.goodsName }</span>
									<span class="issue-pro-quan">외 ${myOrder.orderCount -1} 건</span>
								</div>
							</td>
							<td>
								<span class="cart-prices"> 
									<ins>
										<span class="woocommerce-Price-amount amount"> ${myOrder.orderCount}</span>
									</ins> 
								</span>
							</td>
							<td>
								<span class="cart-prices"> 
									<ins>
										<span class="woocommerce-Price-amount amount">${myOrder.orderTotalprice }</span>
									</ins> 
								</span>
							</td>
							<td class="orderdetail_issueBtn">
								<div class="Btn_box">
									<span>배송전</span>
									<a href="#" title="" id="ocBtn" class="main-btn create-pst order-cancelBtn">취소 요청</a>
								</div>
							</td>
						</tr>
					</c:forEach>
				</c:otherwise>
			</c:choose>
		</table>
		<div class="card-footer prod-footer clearfix" id="pagingArea">
			${pagingVO.pagingHTML }
		</div>
	</div>
</div>

<script type="text/javascript">
	$(function () {
		var pagingArea = $("#pagingArea");
		
		pagingArea.on("click", "a", function (event) {
			event.preventDefault();
			var pageNo = $(this).data("page");
			searchForm.find("#page").val(pageNo);
			searchForm.submit();
		});
		
		var detail = $(".detail");
		
		detail.on("click", function () {
			var orderNo = $(this).data('orderno');
			location.href = "/goods/myOrderDetail.do?orderNo=" + orderNo;
		});
		
		var goods = $(".goods");
		
		goods.on("click", function () {
			var goodsNo = $(this).data('goodsno');
			location.href = "/goods/goodsDetail.do?goodsNo=" + goodsNo;
		});
		
		var ocBtn = $("#ocBtn");
		
		ocBtn.on("click", function (event) {
			event.preventDefault();
			Swal.fire({
	            title: '상품 주문을 취소하시겠습니까?',
	            text: "취소시 전체 취소 됩니다!",
	            icon: 'warning',
	            showCancelButton: true,
	            confirmButtonColor: '#3085d6',
	            cancelButtonColor: '#d33',
	            confirmButtonText: '예, 취소합니다',
	            cancelButtonText: '취소'
	        }).then((result) => {
	        	var goodsNo = $(this).data("goodsno");
					//delFrm.find("#gNo").val(goodsNo);
					//delFrm.submit();
	        	
	            if (result.isConfirmed) {
	                $.ajax({
	                    url: "/goods/ordercancel.do?orderNo="+ orderNo,
	                    method: 'POST',
	                    success: function(data) {
	                        Swal.fire(
	                            '삭제 완료!',
	                            '제품이 취소 되었습니다.',
	                            'success'
	                        ).then(() => {
	                        	window.location.href = "/goods/list.do";
	                        	
	                        });
	                    },
	                    error: function(xhr, status, error) {
	                        Swal.fire(
	                            '취소 실패!',
	                            '취소하는 도중 오류가 발생했습니다.',
	                            'error'
	                        );
	                    }
	                });
	            }
	        });
			
		})
	});
</script>
