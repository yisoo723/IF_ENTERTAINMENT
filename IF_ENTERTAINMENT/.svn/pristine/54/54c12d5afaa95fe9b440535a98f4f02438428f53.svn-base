<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="${pageContext.request.contextPath }/resources/js1/chart.min.js"></script> 
<script src="${pageContext.request.contextPath }/resources/js1/echart.min.js"></script> 
<style>
	.modal-dialog {
	    max-width: 800px;
	    margin: 6.75rem auto;
	}
	#modalBtn {
		border-radius: 25px;
	}
	.modal-body{
		min-height: 500px;
		max-height: 700px;
		overflow-y: auto;
	}
	.modal-backdrop {
		display: none;
	}
	.modal-content {
		top: -62px;
	}
	table td span, th {
	    font-size: 15px;
	}
	table tr th:first-child, table tr td:first-child {
    	padding: 24px 5px;
	}
	table tbody tr td:last-child {
 	    padding: 24px 5px;
	}
</style>

<div class="gap inner-bg">
  <div class="table-styles">
  
  <div class="little-heading">
  	<h2 style="margin-bottom: 30px; font-family: 'GmarketSansMedium';">ğŸ§¾ ì„¤ë¬¸ ëª©ë¡</h2>
  </div>
  
  	<div class="gap listbar-container">
    <div class="discount-copon list-bar">
      <div class="row">
        <div class="col-md-4">
          <form method="post" id="searchForm">
	        <input type="hidden" name="page" id="page"/>
          	<div class="searchform-box" style="display: flex">
	            <input type="text" name="searchWord" value="${searchWord }" placeholder="ì œëª©ìœ¼ë¡œ ê²€ìƒ‰">
		        <button type="submit">ê²€ìƒ‰</button>
	          </div>
	          <sec:csrfInput/>
          </form>
        </div>
        <div class="col-md-2" style="display: flex; justify-content: center;">
        	<form style="width: 150px;">
        		<button type="button" id="RegisterBtn"><i class="fa-solid fa-plus"></i>ë“±ë¡í•˜ê¸°</button>
        		<sec:csrfInput/>
        	</form>
        </div>
      </div>
    </div>
  </div>
    <div class="widget">
      <table class="prj-tbl striped table-responsive">
        <thead class="color">
           <tr class="prodTitle">
             <th><em>ë²ˆí˜¸</em></th>
             <th><em>ì¸ë„¤ì¼</em></th>
             <th><em>ì œëª©</em></th>
             <th><em>ì„¤ë¬¸ê¸°ê°„</em></th>
             <th><em>ê²Œì‹œì—¬ë¶€</em></th>
             <th><em>ë¹„ê³ </em></th>
           </tr>
        </thead>
        <tbody>
        <c:set value="${pagingVO.dataList }" var="surveyFormList"/>
        <c:choose>
        	<c:when test="${empty  surveyFormList}">
        		<tr>
        			<td colspan="7">ì„¤ë¬¸ ë¦¬ìŠ¤íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</td>
        		</tr>
        	</c:when>
        	<c:otherwise>
        		<c:forEach items="${surveyFormList }" var="survey" varStatus="vs">
        			<c:set var="bigo" value="ê²°ê³¼ë³´ê¸°"/>
        			<tr class="prodList" >
			            <td style="text-align: center;"><span>${survey.sfNo }</span></td>
			            <td><img alt="" src="${survey.sfPhoto }" style="width:40px;"></td>
			            <td style="text-align: left;">
			            	<a class="survey_detail" data-sfno="${survey.sfNo }"><span>${survey.sfTitle }</span></a>
			            </td>
			            <td>
			            	<span>
			            		<fmt:formatDate value="${survey.sfRegdate }" pattern="yyyy-MM-dd" /> ~ 
			            		<fmt:formatDate value="${survey.sfEnddate }" pattern="yyyy-MM-dd" />
			            	</span>
			            </td>
			            		
			            <td class="sfDisplay">
			            	<span class="sfDisplaySpan">
			            		<c:choose>
			            			<c:when test="${survey.sfDisplay  eq 'Y'}">
			            				<font class="badge badge-danger" style="font-size: 16px;">ì§„í–‰ì¤‘</font>
			            			</c:when>
			            			<c:otherwise>
			            				<font class="badge badge-secondary" style="font-size: 16px;">ë§ˆê°</font>
			            			</c:otherwise>
			            		</c:choose>
			            		
			            	</span>
			            </td>
			            <td style="text-align: center;">
			            	<button class="btn btn-success finishSurveyBtn" data-idx="${vs.index }" data-sfno="${survey.sfNo }">
			            		<c:if test="${survey.sfDisplay eq 'Y' }">
			            			<c:set var="bigo" value="ì„¤ë¬¸ë§ˆê°"/>
			            		</c:if>
			            		${bigo }
			            	</button>
			            </td>
			          </tr>
        		</c:forEach>
        	</c:otherwise>
        </c:choose>
        </tbody> 
      </table>
<!--       <form action="/goods/delete.do" method="post" id="delFrm"> -->
<!--       	<input type="hidden" name="goodsNo" id="gNo"/> -->
<!--       </form> -->
    </div>
    <div class="card-footer prod-footer clearfix" id="pagingArea">
		${pagingVO.pagingHTML }
	</div>
  </div>
</div>

<!-- ì„¤ë¬¸ í†µê³„ ëª¨ë‹¬ ì‹œì‘  -->
<div class="modal fade" id="myModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<!-- ëª¨ë‹¬ í—¤ë” -->
			<div class="modal-header">
				<h4 class="modal-title">ì„¤ë¬¸ì œëª©!</h4>
				<button type="button" class="close" data-dismiss="modal">Ã—</button>
			</div>
			<!-- ëª¨ë‹¬ ë°”ë”” -->
			<div class="modal-body">
				<!-- í•­ëª©ë³„ ë°˜ë³µêµ¬ê°„ -->
				
			</div>
			<!-- ëª¨ë‹¬ í‘¸í„° -->
			<div class="modal-footer">
				<button type="button" id="modalBtn" class="btn btn-danger" data-dismiss="modal">ë‹«ê¸°</button>
			</div>
		</div>
	</div>
</div>
<!-- ì„¤ë¬¸ í†µê³„ ëª¨ë‹¬ ë  -->
<!-- chart.js cndì¶”ê°€  -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
<script>
$(function(){
	var RegisterBtn = $("#RegisterBtn");		// ìƒˆë¡œìš´ ì„¤ë¬¸ì§€ ë“±ë¡ë²„íŠ¼
	var searchForm = $("#searchForm");			// ê²€ìƒ‰ì°½ í¼
	var pagingArea = $("#pagingArea");			// í˜ì´ì§• ì˜ì—­
	var survey_detail = $(".survey_detail");	// ì œëª©ì„ í´ë¦­í–ˆì„ ë•Œ ì´ë™í•  ë””í…Œì¼ ë§í¬ë“¤
	
	// í˜ì´ì§€ ë²ˆí˜¸ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
	pagingArea.on("click", "a", function(event){
		event.preventDefault();
		var pageNo = $(this).data("page");
		searchForm.find("#page").val(pageNo);
		searchForm.submit();
	});
	
	// ë“±ë¡ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
	RegisterBtn.on("click", function(){
		location.href = "/community/survey/register.do";
	});
	
	// ë””í…Œì¼ë²„íŠ¼ í´ë¦­ ì—ë¹ˆíŠ¸ í•¸ë“¤ëŸ¬
	survey_detail.on("click", function(event){
		event.preventDefault();
		var sfNo = $(this).data("sfno");
		location.href = "/community/survey/detail.do?sfNo=" + sfNo;
	});
	
	// ì¦‰ì‹œë§ˆê°ì¼ ê²½ìš°ì—ëŠ” ë²„íŠ¼ìƒ‰ìƒì„ ë‹¤ë¥´ê²Œ í•œë‹¤.
	$(".finishSurveyBtn").each(function(idx, item) {
	    if ($(item).text().indexOf("ì„¤ë¬¸ë§ˆê°") > -1) {
	        $(item).toggleClass("btn-success btn-primary");
	    }
	});
	
	// ë¹„ê³  ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
	$(".finishSurveyBtn").on("click", function(){
		var sfNo = $(this).data("sfno");
		
// 		// ëª¨ë‹¬ì„ ì—´ê¸° ì „ ë‚´ìš© ì´ˆê¸°í™”
// 		$(".modal-body").html('');
		
		if($(this).text().indexOf("ì„¤ë¬¸ë§ˆê°") > -1){ // ì¦‰ì‹œë§ˆê° ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ê²½ìš°
// 	        // ì´ì „ì— ìƒì„±ëœ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
// 	        $('#myModal').find('.myChart').remove();
			
			var idx = $(this).data("idx");
			
		    Swal.fire({
		        title: 'ì„¤ë¬¸ì„ ë§ˆê° í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 
		        text: "", 
		        icon: 'warning', 
		        showCancelButton: true, // ì·¨ì†Œ ë²„íŠ¼ ë³´ì´ë„ë¡ ì„¤ì •
		        confirmButtonColor: '#3085d6', // ì‚­ì œ ë²„íŠ¼ ìƒ‰ìƒ ì„¤ì •
		        cancelButtonColor: '#d33', // ì·¨ì†Œ ë²„íŠ¼ ìƒ‰ìƒ ì„¤ì •
		        confirmButtonText: 'ë§ˆê°', // ì‚­ì œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
		        cancelButtonText: 'ì·¨ì†Œ' // ì·¨ì†Œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
		    }).then((result) => {
		        if (result.isConfirmed) { 
		        	$.ajax({
		    			url : "/community/survey/close.do?sfNo=" + sfNo,
		    			type : "get",
		    			success: function(data){
		    				console.log(data);
		    				if(data == "SUCCESS"){
		    					$(".sfDisplaySpan").eq(idx).text("N");
		    					$(".finishSurveyBtn").eq(idx).text("ê²°ê³¼ë³´ê¸°");
		    					$(".finishSurveyBtn").eq(idx).removeClass("btn-primary");
		    					$(".finishSurveyBtn").eq(idx).addClass("btn-success");
		    					Swal.fire({
		    						icon : "success",
		    						title : "ì„¤ë¬¸ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤!",
		    						showConfirmButton : false,
		    						timer : 1000
		    					});		
		    				}
		    			}
		    		});
		        }
		    });
			
		} else { // ê²°ê³¼ë³´ê¸° ì¼ê²½ìš°
// 	        // ì´ì „ì— ìƒì„±ëœ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
// 	        $('#myModal').find('.myChart').remove();
			
			// í•´ë‹¹ ì„¤ë¬¸ì˜ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
			$.ajax({
				url: "/community/survey/getResult?sfNo=" + sfNo,
				type: "get",
				beforeSend: function(xhr){
					xhr.setRequestHeader(header, token);
				},
				success: function(data){
// 					console.log("data => ", data);
					
					var html = '';
						
					for(var i = 0; i < data[0].surveyQuestionList.length; i++){
						var sqTitle = data[0].surveyQuestionList[i].sqTitle;
						var sqType = '';
						if(data[0].surveyQuestionList[i].sqType == 'checkbox'){
							var sqType = '(ì¤‘ë³µì„ íƒí—ˆìš©)';
						}
						html += '					<div class="col-sm-12">';
						html += '						<div class="widget" style="padding-bottom: 40px;">';
						html += '							<div class="widget-title">';
						html += '								<h4>' + sqTitle + '</h4>';
						html += '								<em>' + sqType + '</em>';
						html += '							</div>';
						html += '							<div class="mst-brw">';
						html += '								<div class="most-browsers">';
						html += '									<div class="charts">';
						html += '										<canvas class="myChart"></canvas>';
						html += '									</div>';
						html += '									<ul class="pieID legend">';
						
						for(var j = 0; j < data[0].surveyQuestionList[i].optionList.length; j++){
							var soContent = data[0].surveyQuestionList[i].optionList[j].soContent;
							var cnt = data[0].surveyQuestionList[i].optionList[j].cnt;
							html += '									<li><em>' + soContent + '</em> <span>' + cnt + '</span></li>';
						}
						html += '									</ul>';
						html += '								</div>';
						html += '							</div>';
						html += '						</div>';
						html += '					</div>';
					}
					$(".modal-body").html(html);
					
					$("#myModal").one("shown.bs.modal", function () {
						setTimeout(() => {
			                createChart($(this), data); // ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ
						}, 10);
		            });
					
					$("#myModal").modal();
					
				}
			});
		}
	});
	
	// ì°¨íŠ¸ ìƒ‰ìƒ ë°°ì—´
	var bgColorArray = [
		'rgb(242, 155, 155)',
		'rgb(247, 154, 114)',
		'rgb(250, 208, 102)',
		'rgb(143, 245, 127)',
		'rgb(127, 204, 245)',
		'rgb(81, 102, 237)',
		'rgb(139, 77, 247)',
		'rgb(180, 33, 209)',
		'rgb(108, 212, 181)',
		'rgb(122, 173, 114)'	
	];
	
	// ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
	function createChart(parent, charData) {
		// data ë°°ì—´ì´ ë¹„ì–´ ìˆëŠ”ì§€ í™•ì¸
// 		console.log("ccì•ˆì˜ ", charData);
		
	    parent.find('.myChart').each(function(index) { // ê° ëª¨ë‹¬ ë‚´ì˜ .myChart ìš”ì†Œë¥¼ ì„ íƒí•˜ì—¬ ë°˜ë³µë¬¸ ì‹¤í–‰
			
	    	console.log("### ê°ê°ì˜ myChart", $(this));
	    	
	    	// eqchë°˜ë³µë¬¸ì„ ëŒë©° ê°ê°ì˜ ë°°ì—´ì— dataì—ì„œ êº¼ë‚¸ cntListì™€ optionListë¥¼ ë‹´ê³  ì•„ë˜ ì°¨íŠ¸ì— ì„¸íŒ…í•´ì¤€ë‹¤.
	    	var ctx = $(this);
	    	var cnts = [];
	    	var options = [];
	    
	    	for(var i = 0; i < charData[0].surveyQuestionList.length; i++){
		    	var cntList = charData[0].surveyQuestionList[i].cntList;
		    	cnts.push(cntList);
	    	}
	    	
	    	for(var j = 0; j < charData[0].surveyQuestionList.length; j++){
		    	var optionList = charData[0].surveyQuestionList[j].optionList;
		    	var optionArr = [];
		    	for(var k = 0; k < optionList.length; k++){
// 			    	console.log("plz ", optionList[k].soContent);
		    		optionArr.push(optionList[k].soContent);
		    	}
		    	options.push(optionArr);
	    	}
	    	
	        
	        // data = ë³´ê¸°ë‚´ìš©
	        var data = {
	            labels: options[index],
	            // datasets = ì„ íƒì¸ì›
	            datasets: [{
	                label: 'My First Dataset',
	                data: cnts[index],
	                backgroundColor: [
	                    bgColorArray[0],
	                    bgColorArray[1],
	                    bgColorArray[2],
	                    bgColorArray[3],
	                    bgColorArray[4],
	                    bgColorArray[5],
	                    bgColorArray[6],
	                    bgColorArray[7],
	                    bgColorArray[8],
	                    bgColorArray[9]
	                ],
	                hoverOffset: 4
	            }]
	        };

	        new Chart(ctx, {
	            type: 'pie',
	            data: data
	        });
	    });
	}
});
</script>