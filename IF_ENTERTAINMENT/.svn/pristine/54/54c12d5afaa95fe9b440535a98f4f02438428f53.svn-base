<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="${pageContext.request.contextPath }/resources/js1/chart.min.js"></script> 
<script src="${pageContext.request.contextPath }/resources/js1/echart.min.js"></script> 
<style>
	.modal-dialog {
	    max-width: 800px;
	    margin: 6.75rem auto;
	}
	#modalBtn {
		border-radius: 25px;
	}
	.modal-body{
		min-height: 500px;
		max-height: 700px;
		overflow-y: auto;
	}
	.modal-backdrop {
		display: none;
	}
	.modal-content {
		top: -62px;
	}
	table td span, th {
	    font-size: 15px;
	}
	table tr th:first-child, table tr td:first-child {
    	padding: 24px 5px;
	}
	table tbody tr td:last-child {
 	    padding: 24px 5px;
	}
</style>

<div class="gap inner-bg">
  <div class="table-styles">
  
  <div class="little-heading">
  	<h2 style="margin-bottom: 30px; font-family: 'GmarketSansMedium';">üßæ ÏÑ§Î¨∏ Î™©Î°ù</h2>
  </div>
  
  	<div class="gap listbar-container">
    <div class="discount-copon list-bar">
      <div class="row">
        <div class="col-md-4">
          <form method="post" id="searchForm">
	        <input type="hidden" name="page" id="page"/>
          	<div class="searchform-box" style="display: flex">
	            <input type="text" name="searchWord" value="${searchWord }" placeholder="Ï†úÎ™©ÏúºÎ°ú Í≤ÄÏÉâ">
		        <button type="submit">Í≤ÄÏÉâ</button>
	          </div>
	          <sec:csrfInput/>
          </form>
        </div>
        <div class="col-md-2" style="display: flex; justify-content: center;">
        	<form style="width: 150px;">
        		<button type="button" id="RegisterBtn"><i class="fa-solid fa-plus"></i>Îì±Î°ùÌïòÍ∏∞</button>
        		<sec:csrfInput/>
        	</form>
        </div>
      </div>
    </div>
  </div>
    <div class="widget">
      <table class="prj-tbl striped table-responsive">
        <thead class="color">
           <tr class="prodTitle">
             <th><em>Î≤àÌò∏</em></th>
             <th><em>Ïç∏ÎÑ§Ïùº</em></th>
             <th><em>Ï†úÎ™©</em></th>
             <th><em>ÏÑ§Î¨∏Í∏∞Í∞Ñ</em></th>
             <th><em>Í≤åÏãúÏó¨Î∂Ä</em></th>
             <th><em>ÎπÑÍ≥†</em></th>
           </tr>
        </thead>
        <tbody>
        <c:set value="${pagingVO.dataList }" var="surveyFormList"/>
        <c:choose>
        	<c:when test="${empty  surveyFormList}">
        		<tr>
        			<td colspan="7">ÏÑ§Î¨∏ Î¶¨Ïä§Ìä∏Í∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.</td>
        		</tr>
        	</c:when>
        	<c:otherwise>
        		<c:forEach items="${surveyFormList }" var="survey" varStatus="vs">
        			<c:set var="bigo" value="Í≤∞Í≥ºÎ≥¥Í∏∞"/>
        			<tr class="prodList" >
			            <td style="text-align: center;"><span>${survey.sfNo }</span></td>
			            <td><img alt="" src="${survey.sfPhoto }" style="width:40px;"></td>
			            <td style="text-align: left;">
			            	<a class="survey_detail" data-sfno="${survey.sfNo }"><span>${survey.sfTitle }</span></a>
			            </td>
			            <td>
			            	<span>
			            		<fmt:formatDate value="${survey.sfRegdate }" pattern="yyyy-MM-dd" /> ~ 
			            		<fmt:formatDate value="${survey.sfEnddate }" pattern="yyyy-MM-dd" />
			            	</span>
			            </td>
			            		
			            <td class="sfDisplay">
			            	<span class="sfDisplaySpan">
			            		<c:choose>
			            			<c:when test="${survey.sfDisplay  eq 'Y'}">
			            				<font class="badge badge-danger" style="font-size: 16px;">ÏßÑÌñâÏ§ë</font>
			            			</c:when>
			            			<c:otherwise>
			            				<font class="badge badge-secondary" style="font-size: 16px;">ÎßàÍ∞ê</font>
			            			</c:otherwise>
			            		</c:choose>
			            		
			            	</span>
			            </td>
			            <td style="text-align: center;">
			            	<button class="btn btn-success finishSurveyBtn" data-idx="${vs.index }" data-sfno="${survey.sfNo }">
			            		<c:if test="${survey.sfDisplay eq 'Y' }">
			            			<c:set var="bigo" value="ÏÑ§Î¨∏ÎßàÍ∞ê"/>
			            		</c:if>
			            		${bigo }
			            	</button>
			            </td>
			          </tr>
        		</c:forEach>
        	</c:otherwise>
        </c:choose>
        </tbody> 
      </table>
<!--       <form action="/goods/delete.do" method="post" id="delFrm"> -->
<!--       	<input type="hidden" name="goodsNo" id="gNo"/> -->
<!--       </form> -->
    </div>
    <div class="card-footer prod-footer clearfix" id="pagingArea">
		${pagingVO.pagingHTML }
	</div>
  </div>
</div>

<!-- ÏÑ§Î¨∏ ÌÜµÍ≥Ñ Î™®Îã¨ ÏãúÏûë  -->
<div class="modal fade" id="myModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<!-- Î™®Îã¨ Ìó§Îçî -->
			<div class="modal-header">
				<h4 class="modal-title">ÏÑ§Î¨∏Ï†úÎ™©!</h4>
				<button type="button" class="close" data-dismiss="modal">√ó</button>
			</div>
			<!-- Î™®Îã¨ Î∞îÎîî -->
			<div class="modal-body">
				<!-- Ìï≠Î™©Î≥Ñ Î∞òÎ≥µÍµ¨Í∞Ñ -->
				
			</div>
			<!-- Î™®Îã¨ Ìë∏ÌÑ∞ -->
			<div class="modal-footer">
				<button type="button" id="modalBtn" class="btn btn-danger" data-dismiss="modal">Îã´Í∏∞</button>
			</div>
		</div>
	</div>
</div>
<!-- ÏÑ§Î¨∏ ÌÜµÍ≥Ñ Î™®Îã¨ ÎÅù  -->
<!-- chart.js cndÏ∂îÍ∞Ä  -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
<script>
$(function(){
	var RegisterBtn = $("#RegisterBtn");		// ÏÉàÎ°úÏö¥ ÏÑ§Î¨∏ÏßÄ Îì±Î°ùÎ≤ÑÌäº
	var searchForm = $("#searchForm");			// Í≤ÄÏÉâÏ∞Ω Ìèº
	var pagingArea = $("#pagingArea");			// ÌéòÏù¥Ïßï ÏòÅÏó≠
	var survey_detail = $(".survey_detail");	// Ï†úÎ™©ÏùÑ ÌÅ¥Î¶≠ÌñàÏùÑ Îïå Ïù¥ÎèôÌï† ÎîîÌÖåÏùº ÎßÅÌÅ¨Îì§
	
	// ÌéòÏù¥ÏßÄ Î≤àÌò∏ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
	pagingArea.on("click", "a", function(event){
		event.preventDefault();
		var pageNo = $(this).data("page");
		searchForm.find("#page").val(pageNo);
		searchForm.submit();
	});
	
	// Îì±Î°ùÎ≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
	RegisterBtn.on("click", function(){
		location.href = "/community/survey/register.do";
	});
	
	// ÎîîÌÖåÏùºÎ≤ÑÌäº ÌÅ¥Î¶≠ ÏóêÎπàÌä∏ Ìï∏Îì§Îü¨
	survey_detail.on("click", function(event){
		event.preventDefault();
		var sfNo = $(this).data("sfno");
		location.href = "/community/survey/detail.do?sfNo=" + sfNo;
	});
	
	// Ï¶âÏãúÎßàÍ∞êÏùº Í≤ΩÏö∞ÏóêÎäî Î≤ÑÌäºÏÉâÏÉÅÏùÑ Îã§Î•¥Í≤å ÌïúÎã§.
	$(".finishSurveyBtn").each(function(idx, item) {
	    if ($(item).text().indexOf("ÏÑ§Î¨∏ÎßàÍ∞ê") > -1) {
	        $(item).toggleClass("btn-success btn-primary");
	    }
	});
	
	// ÎπÑÍ≥† Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
	$(".finishSurveyBtn").on("click", function(){
		var sfNo = $(this).data("sfno");
		
// 		// Î™®Îã¨ÏùÑ Ïó¥Í∏∞ Ï†Ñ ÎÇ¥Ïö© Ï¥àÍ∏∞Ìôî
// 		$(".modal-body").html('');
		
		if($(this).text().indexOf("ÏÑ§Î¨∏ÎßàÍ∞ê") > -1){ // Ï¶âÏãúÎßàÍ∞ê Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌñàÏùÑ Í≤ΩÏö∞
// 	        // Ïù¥Ï†ÑÏóê ÏÉùÏÑ±Îêú Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ ÏÇ≠Ï†ú
// 	        $('#myModal').find('.myChart').remove();
			
			var idx = $(this).data("idx");
			
		    Swal.fire({
		        title: 'ÏÑ§Î¨∏ÏùÑ ÎßàÍ∞ê ÌïòÏãúÍ≤†ÏäµÎãàÍπå?', 
		        text: "", 
		        icon: 'warning', 
		        showCancelButton: true, // Ï∑®ÏÜå Î≤ÑÌäº Î≥¥Ïù¥ÎèÑÎ°ù ÏÑ§Ï†ï
		        confirmButtonColor: '#3085d6', // ÏÇ≠Ï†ú Î≤ÑÌäº ÏÉâÏÉÅ ÏÑ§Ï†ï
		        cancelButtonColor: '#d33', // Ï∑®ÏÜå Î≤ÑÌäº ÏÉâÏÉÅ ÏÑ§Ï†ï
		        confirmButtonText: 'ÎßàÍ∞ê', // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
		        cancelButtonText: 'Ï∑®ÏÜå' // Ï∑®ÏÜå Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
		    }).then((result) => {
		        if (result.isConfirmed) { 
		        	$.ajax({
		    			url : "/community/survey/close.do?sfNo=" + sfNo,
		    			type : "get",
		    			success: function(data){
		    				console.log(data);
		    				if(data == "SUCCESS"){
		    					$(".sfDisplaySpan").eq(idx).text("N");
		    					$(".finishSurveyBtn").eq(idx).text("Í≤∞Í≥ºÎ≥¥Í∏∞");
		    					$(".finishSurveyBtn").eq(idx).removeClass("btn-primary");
		    					$(".finishSurveyBtn").eq(idx).addClass("btn-success");
		    					Swal.fire({
		    						icon : "success",
		    						title : "ÏÑ§Î¨∏Ïù¥ ÎßàÍ∞êÎêòÏóàÏäµÎãàÎã§!",
		    						showConfirmButton : false,
		    						timer : 1000
		    					});		
		    				}
		    			}
		    		});
		        }
		    });
			
		} else { // Í≤∞Í≥ºÎ≥¥Í∏∞ ÏùºÍ≤ΩÏö∞
// 	        // Ïù¥Ï†ÑÏóê ÏÉùÏÑ±Îêú Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ ÏÇ≠Ï†ú
// 	        $('#myModal').find('.myChart').remove();
			
			// Ìï¥Îãπ ÏÑ§Î¨∏Ïùò Í≤∞Í≥ºÎ•º Í∞ÄÏ†∏Ïò®Îã§.
			$.ajax({
				url: "/community/survey/getResult?sfNo=" + sfNo,
				type: "get",
				beforeSend: function(xhr){
					xhr.setRequestHeader(header, token);
				},
				success: function(data){
// 					console.log("data => ", data);
					
					var html = '';
						
					for(var i = 0; i < data[0].surveyQuestionList.length; i++){
						var sqTitle = data[0].surveyQuestionList[i].sqTitle;
						var sqType = '';
						if(data[0].surveyQuestionList[i].sqType == 'checkbox'){
							var sqType = '(Ï§ëÎ≥µÏÑ†ÌÉùÌóàÏö©)';
						}
						html += '					<div class="col-sm-12">';
						html += '						<div class="widget" style="padding-bottom: 40px;">';
						html += '							<div class="widget-title">';
						html += '								<h4>' + sqTitle + '</h4>';
						html += '								<em>' + sqType + '</em>';
						html += '							</div>';
						html += '							<div class="mst-brw">';
						html += '								<div class="most-browsers">';
						html += '									<div class="charts">';
						html += '										<canvas class="myChart"></canvas>';
						html += '									</div>';
						html += '									<ul class="pieID legend">';
						
						for(var j = 0; j < data[0].surveyQuestionList[i].optionList.length; j++){
							var soContent = data[0].surveyQuestionList[i].optionList[j].soContent;
							var cnt = data[0].surveyQuestionList[i].optionList[j].cnt;
							html += '									<li><em>' + soContent + '</em> <span>' + cnt + '</span></li>';
						}
						html += '									</ul>';
						html += '								</div>';
						html += '							</div>';
						html += '						</div>';
						html += '					</div>';
					}
					$(".modal-body").html(html);
					
					$("#myModal").one("shown.bs.modal", function () {
						setTimeout(() => {
			                createChart($(this), data); // Ï∞®Ìä∏ ÏÉùÏÑ± Ìï®Ïàò Ìò∏Ï∂ú
						}, 10);
		            });
					
					$("#myModal").modal();
					
				}
			});
		}
	});
	
	// Ï∞®Ìä∏ ÏÉâÏÉÅ Î∞∞Ïó¥
	var bgColorArray = [
		'rgb(242, 155, 155)',
		'rgb(247, 154, 114)',
		'rgb(250, 208, 102)',
		'rgb(143, 245, 127)',
		'rgb(127, 204, 245)',
		'rgb(81, 102, 237)',
		'rgb(139, 77, 247)',
		'rgb(180, 33, 209)',
		'rgb(108, 212, 181)',
		'rgb(122, 173, 114)'	
	];
	
	// Ï∞®Ìä∏ ÏÉùÏÑ± Ìï®Ïàò
	function createChart(parent, charData) {
		// data Î∞∞Ïó¥Ïù¥ ÎπÑÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
// 		console.log("ccÏïàÏùò ", charData);
		
	    parent.find('.myChart').each(function(index) { // Í∞Å Î™®Îã¨ ÎÇ¥Ïùò .myChart ÏöîÏÜåÎ•º ÏÑ†ÌÉùÌïòÏó¨ Î∞òÎ≥µÎ¨∏ Ïã§Ìñâ
			
	    	console.log("### Í∞ÅÍ∞ÅÏùò myChart", $(this));
	    	
	    	// eqchÎ∞òÎ≥µÎ¨∏ÏùÑ ÎèåÎ©∞ Í∞ÅÍ∞ÅÏùò Î∞∞Ïó¥Ïóê dataÏóêÏÑú Í∫ºÎÇ∏ cntListÏôÄ optionListÎ•º Îã¥Í≥† ÏïÑÎûò Ï∞®Ìä∏Ïóê ÏÑ∏ÌåÖÌï¥Ï§ÄÎã§.
	    	var ctx = $(this);
	    	var cnts = [];
	    	var options = [];
	    
	    	for(var i = 0; i < charData[0].surveyQuestionList.length; i++){
		    	var cntList = charData[0].surveyQuestionList[i].cntList;
		    	cnts.push(cntList);
	    	}
	    	
	    	for(var j = 0; j < charData[0].surveyQuestionList.length; j++){
		    	var optionList = charData[0].surveyQuestionList[j].optionList;
		    	var optionArr = [];
		    	for(var k = 0; k < optionList.length; k++){
// 			    	console.log("plz ", optionList[k].soContent);
		    		optionArr.push(optionList[k].soContent);
		    	}
		    	options.push(optionArr);
	    	}
	    	
	        
	        // data = Î≥¥Í∏∞ÎÇ¥Ïö©
	        var data = {
	            labels: options[index],
	            // datasets = ÏÑ†ÌÉùÏù∏Ïõê
	            datasets: [{
	                label: 'My First Dataset',
	                data: cnts[index],
	                backgroundColor: [
	                    bgColorArray[0],
	                    bgColorArray[1],
	                    bgColorArray[2],
	                    bgColorArray[3],
	                    bgColorArray[4],
	                    bgColorArray[5],
	                    bgColorArray[6],
	                    bgColorArray[7],
	                    bgColorArray[8],
	                    bgColorArray[9]
	                ],
	                hoverOffset: 4
	            }]
	        };

	        new Chart(ctx, {
	            type: 'pie',
	            data: data
	        });
	    });
	}
});
</script>