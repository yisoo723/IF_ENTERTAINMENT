<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>    


<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<style type="text/css">
.image-container {
    display: flex;
    justify-content: center; /* 가로 중앙 정렬 */
    align-items: center; /* 세로 중앙 정렬 */
    height: 100px; /* 부모 요소의 높이를 지정 */
}
</style>
  <link rel="icon" href="images/fav.png" type="image/png" sizes="16x16"> 
  <link rel="stylesheet" href="${pageContext.request.contextPath }/resources/css/main.min.css">
<%--   <link rel="stylesheet" href="${pageContext.request.contextPath }/resources/css/style.css"> --%>
  <link rel="stylesheet" href="${pageContext.request.contextPath }/resources/css/color.css">
  <link rel="stylesheet" href="${pageContext.request.contextPath }/resources/css/responsive.css">
</head>
<body>
<div class="col-lg-12">
								<div class="central-meta">
									<h4 class="create-post">Cart</h4>
									<div class="cart-sec">
										<table class="table table-responsive">
											<tr>
												<th>상품명</th>
												<th>가격</th>
												<th>수량</th>
												<th>총 가격</th>
											</tr>
											<c:forEach var="list" items="${list }">
											<tr>
												<td>
													<a href="#" title="" class="delete-cart"><i class="ti-close"></i></a>
													<div class="cart-avatar">
														<div class="image-container">
														    <img src="${list.cartThumbnail}" style="width: 80px; height: 80px;"  alt="">
													<input type="hidden" class="userNo" name="userNo" value="${list.userNo }">
													<input type="hidden" class="goodsNo" name="goodsNo" value="${list.goodsNo }">
														</div>
													</div>
													<div class="cart-meta">
														<span>${list.cartName }</span>
													</div>
												</td>
												<td>
													<span class="cart-prices"> 
														<ins>
															<span class="woocommerce-Price-amount amount"><span class="woocommerce-Price-currencySymbol">&#8361;</span>${list.cartPrice }</span>
														</ins> 
													</span>
												</td>
												<td>
													     <div class="cart-list-quantity">
												                <div class="c-input-number">
												                    <button class="decrease-quantity">-</button>
												                    <input type="text" class="manual-adjust" value="${list.cartQuantity}" data-price="${list.cartPrice}" data-goodsno="${list.goodsNo}" data-userno="${list.userNo}"/>
												                    <button class="increase-quantity">+</button>
												                </div>
												            </div>
												        </td>
												        <td>
												            <span class="total-price">${list.cartQuantity * list.cartPrice}</span>
												        </td>
											</tr>
											</c:forEach>
										</table>
									</div>
									<div class="row">
										<div class="col-lg-6">
											<div class="amount-area">
												
												<!-- 총합계를 표시할 부분 -->
										<div class="total-area">
										    <ul>
										        <li>
										            <span>Cart Subtotal:</span>
										            <i id="cartSubtotal">$0.00</i>
										        </li>
										        <li>
										            <span>Shipping:</span>
										            <i>Free</i>
										        </li>
										        <li class="order-total">
										            <span>ORDER TOTAL:</span>
										            <i id="orderTotal">$0.00</i>
										        </li>
										    </ul>
										</div>

											</div>
										</div>
										<div class="col-lg-6">
											<form method="post" class="coupon-code">
													<input type="text" placeholder="Enter your Coupon">
													<button><i class="fa-regular fa-paper-plane"></i></button>
												</form>
											<div class="proceed">
												<a href="#" title="" class="main-btn3">Update Cart</a>
												<a href="#" title="" class="main-btn">Proceed to Chefdckout</a>
											</div>
										</div>
									</div>
								</div>
							</div>
</body>
	<script src="${pageContext.request.contextPath }/resources/js/main.min.js"></script>
	<script src="${pageContext.request.contextPath }/resources/js/userincr.js"></script>
	<script src="js/script.js"></script>
	
<script type="text/javascript">
$(document).ready(function() {
    $('.delete-cart').click(function(event) {
        event.preventDefault();
        
        var $this = $(this); 
        var goodsNo = $this.closest('tr').find('.goodsNo').val();
        var userNo = $this.closest('tr').find('.userNo').val();

        swal.fire({
            title: "삭제하시겠습니까?",
            text: "이 작업은 되돌릴 수 없습니다",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: '예',
            cancelButtonText: '아니오',
            reverseButtons: false
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: "POST",
                    url: "/goods/goodsCartDelete.do",
                    contentType: "application/json",
                    data: JSON.stringify({
                        goodsNo: goodsNo,
                        userNo: userNo
                    }),
                    success: function(response) {
                        swal.fire({
                            title: "삭제가 완료되었습니다!",
                            icon: "success",
                            showCancelButton: false,
                            timer : 1500
                        }).then(() => {
                            window.location.href = '/goods/goodsCart.do'; // 여기서는 삭제 후 장바구니 페이지로 이동합니다.
                        });
                    },
                    error: function(xhr, status, error) {
                        swal.fire("오류", "오류가 발생했습니다. 다시 시도해주세요.", "error");
                    }
                });
            }
        });
    }); 
}); 
</script>
<script>
$(document).ready(function() {
    // 수량 조절 버튼 이벤트 핸들러
    $('.decrease-quantity, .increase-quantity').click(function() {
        var $input = $(this).siblings('input.manual-adjust');
        var currentQuantity = parseInt($input.val());
        var pricePerItem = parseFloat($input.data('price'));
        var goodsNo = $input.data('goodsno');
        var userNo = $input.data('userno');

        if ($(this).hasClass('increase-quantity')) {
            currentQuantity++;
        } else if ($(this).hasClass('decrease-quantity') && currentQuantity > 1) {
            currentQuantity--;
        }
        
        $input.val(currentQuantity);
        updateTotalsJQuery();

        // AJAX 요청으로 수량 업데이트
        $.ajax({
            type: "POST",
            url: "/path/to/updateQuantity", // 서버의 수량 업데이트 처리 경로
            data: {
                goodsNo: goodsNo,
                userNo: userNo,
                quantity: currentQuantity
            },
            success: function(response) {
                console.log("수량 업데이트 성공");
            },
            error: function(xhr, status, error) {
                console.log("수량 업데이트 실패");
            }
        });
    });

    function updateTotalsJQuery() {
        var total = 0;
        $('.cart-sec .table tr').each(function() {
            var price = parseFloat($(this).find('.cart-prices ins .woocommerce-Price-amount').text().replace(/[^0-9.-]+/g,""));
            var quantity = parseInt($(this).find('.manual-adjust').val());
            var rowTotal = price * quantity;
            $(this).find('.total-price').text(rowTotal.toFixed(2));
            total += rowTotal;
        });

        $('#cartSubtotal').text(`₩${total.toFixed(2)}`);
        $('#orderTotal').text(`₩${total.toFixed(2)}`);
    }
    
    // 페이지 로드 시 총액 업데이트
    updateTotalsJQuery();
});
</script>
	
	
	
</html>