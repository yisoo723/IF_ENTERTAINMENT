<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="${pageContext.request.contextPath }/resources/js1/chart.min.js"></script> 
<script src="${pageContext.request.contextPath }/resources/js1/echart.min.js"></script> 
<style>
	.modal-dialog {
	    max-width: 800px;
	    margin: 6.75rem auto;
	}
	#modalBtn {
		border-radius: 25px;
	}
	.modal-body{
		min-height: 500px;
		max-height: 700px;
		overflow-y: auto;
	}
	.modal-backdrop {
		display: none;
	}
	.modal-content {
		top: -150px;
	}
</style>

<div class="gap inner-bg">
  <div class="table-styles">
  
  <div class="little-heading">
  	<h2 style="margin-bottom: 30px">설문 목록</h2>
  </div>
  
  	<div class="gap listbar-container">
    <div class="discount-copon list-bar">
      <div class="row">
        <div class="col-md-4">
          <form method="post" id="searchForm">
	        <input type="hidden" name="page" id="page"/>
          	<div class="searchform-box" style="display: flex">
	            <input type="text" name="searchWord" value="${searchWord }" placeholder="제목으로 검색">
		        <button type="submit">검색</button>
	          </div>
          </form>
        </div>
        <div class="col-md-3" style="display: flex;">
        	<form>
        		<button type="button" id="RegisterBtn"><i class="fa-solid fa-plus"></i>등록하기</button>
        	</form>
        </div>
      </div>
    </div>
  </div>
    <div class="widget">
      <table class="prj-tbl striped table-responsive">
        <thead class="color">
           <tr class="prodTitle">
             <th><em>번호</em></th>
             <th><em>썸네일</em></th>
             <th><em>제목</em></th>
             <th><em>시작일</em></th>
             <th><em>마감일</em></th>
             <th><em>게시여부</em></th>
             <th><em>비고</em></th>
           </tr>
        </thead>
        <tbody>
        <c:set value="${pagingVO.dataList }" var="surveyFormList"/>
        <c:choose>
        	<c:when test="${empty  surveyFormList}">
        		<tr>
        			<td colspan="7">설문 리스트가 존재하지 않습니다.</td>
        		</tr>
        	</c:when>
        	<c:otherwise>
        		<c:forEach items="${surveyFormList }" var="survey" varStatus="vs">
        			<c:set var="bigo" value="결과보기"/>
        			<tr class="prodList" >
			            <td><span>${survey.sfNo }</span></td>
			            <td><img alt="" src="${survey.sfPhoto }" style="width:40px;"></td>
			            <td><a class="survey_detail" data-sfno="${survey.sfNo }"><span>${survey.sfTitle }</span></a></td>
			            <td>
			            	<span>
			            		<fmt:formatDate value="${survey.sfRegdate }" pattern="yyyy-MM-dd" />
			            	</span>
			            </td>
			            <td>
			            	<span>
			            		<fmt:formatDate value="${survey.sfEnddate }" pattern="yyyy-MM-dd" />
			            	</span>
			            </td> 
			            <td class="sfDisplay"><span class="sfDisplaySpan">${survey.sfDisplay }</span></td>
			            <td>
			            	<button class="btn btn-success finishSurveyBtn" data-idx="${vs.index }" data-sfno="${survey.sfNo }">
			            		<c:if test="${survey.sfDisplay eq 'Y' }">
			            			<c:set var="bigo" value="설문마감"/>
			            		</c:if>
			            		${bigo }
			            	</button>
			            </td>
			          </tr>
        		</c:forEach>
        	</c:otherwise>
        </c:choose>
        </tbody> 
      </table>
      <form action="/goods/delete.do" method="post" id="delFrm">
      	<input type="hidden" name="goodsNo" id="gNo"/>
      </form>
    </div>
    <div class="card-footer prod-footer clearfix" id="pagingArea">
		${pagingVO.pagingHTML }
	</div>
  </div>
</div>

<!-- 설문 통계 모달 시작  -->
<div class="modal fade" id="myModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<!-- 모달 헤더 -->
			<div class="modal-header">
				<h4 class="modal-title">설문제목!!!</h4>
				<button type="button" class="close" data-dismiss="modal">×</button>
			</div>
			<!-- 모달 바디 -->
			<div class="modal-body">
				<!-- 항목별 반복구간 -->
					<c:forEach items="surveyResultList" var="surveyResult">
					<div class="col-sm-12">
						<div class="widget">
							<div class="widget-title">
								<h4>가장 좋아하는 연예인은 누구입니까?</h4>
								<em>(중복선택 허용)</em>
							</div>
							<div class="mst-brw">
								<div class="most-browsers">
									<div class="charts">
										<canvas class="myChart"></canvas>
									</div>
									<ul class="pieID legend">
										<li><em>Red</em> <span>1118</span></li>
										<li><em>Blue</em> <span>300</span></li>
										<li><em>Yellow</em> <span>300</span></li>
										<li><em>Olive</em> <span>500</span></li>
										<li><em>Orange</em> <span>400</span></li>
									</ul>
								</div>
								<a href="#" title=""><i class="fa fa-cog"></i> 상세보기</a>
							</div>
						</div>
					</div>
				</c:forEach>
				<!-- 항목별 반복구간 끝 -->
			</div>
			<!-- 모달 푸터 -->
			<div class="modal-footer">
				<button type="button" id="modalBtn" class="btn btn-danger" data-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>
<!-- 설문 통계 모달 끝  -->
<!-- chart.js cnd추가  -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
<script>
$(function(){
	var RegisterBtn = $("#RegisterBtn");		// 새로운 설문지 등록버튼
	var searchForm = $("#searchForm");			// 검색창 폼
	var pagingArea = $("#pagingArea");			// 페이징 영역
	var survey_detail = $(".survey_detail");	// 제목을 클릭했을 때 이동할 디테일 링크들
	
	// 페이지 번호 클릭 이벤트 핸들러
	pagingArea.on("click", "a", function(event){
		event.preventDefault();
		var pageNo = $(this).data("page");
		searchForm.find("#page").val(pageNo);
		searchForm.submit();
	});
	
	// 등록버튼 클릭 이벤트 핸들러
	RegisterBtn.on("click", function(){
		location.href = "/community/survey/register.do";
	});
	
	// 디테일버튼 클릭 에빈트 핸들러
	survey_detail.on("click", function(event){
		event.preventDefault();
		var sfNo = $(this).data("sfno");
		location.href = "/community/survey/detail.do?sfNo=" + sfNo;
	});
	
	// 즉시마감일 경우에는 버튼색상을 다르게 한다.
	$(".finishSurveyBtn").each(function(idx, item) {
	    if ($(item).text().indexOf("설문마감") > -1) {
	        $(item).toggleClass("btn-success btn-primary");
	    }
	});
	
	// 비고 버튼 클릭 이벤트 핸들러
	$(".finishSurveyBtn").on("click", function(){
		var sfNo = $(this).data("sfno");
		
		if($(this).text().indexOf("설문마감") > -1){ // 즉시마감 버튼을 클릭했을 경우
			var idx = $(this).data("idx");
			
		    Swal.fire({
		        title: '설문을 마감 하시겠습니까?', 
		        text: "", 
		        icon: 'warning', 
		        showCancelButton: true, // 취소 버튼 보이도록 설정
		        confirmButtonColor: '#3085d6', // 삭제 버튼 색상 설정
		        cancelButtonColor: '#d33', // 취소 버튼 색상 설정
		        confirmButtonText: '마감', // 삭제 버튼 텍스트 설정
		        cancelButtonText: '취소' // 취소 버튼 텍스트 설정
		    }).then((result) => {
		        if (result.isConfirmed) { 
		        	$.ajax({
		    			url : "/community/survey/close.do?sfNo=" + sfNo,
		    			type : "get",
		    			success: function(data){
		    				console.log(data);
		    				if(data == "SUCCESS"){
		    					$(".sfDisplaySpan").eq(idx).text("N");
		    					$(".finishSurveyBtn").eq(idx).text("결과보기");
		    					$(".finishSurveyBtn").eq(idx).removeClass("btn-primary");
		    					$(".finishSurveyBtn").eq(idx).addClass("btn-success");
		    					Swal.fire({
		    						icon : "success",
		    						title : "설문이 마감되었습니다!",
		    						showConfirmButton : false,
		    						timer : 1000
		    					});		
		    				}
		    			}
		    		});
		        }
		    });
			
		} else { // 결과보기 일경우
			
			// 해당 설문의 결과를 가져온다.
			$.ajax({
				url: "/community/survey/getResult?sfNo=" + sfNo,
				type: "get",
				success: function(data){
					console.log("data => ", data);
					
					$("#myModal").on("shown.bs.modal", function () {
		                createChart(); // 차트 생성 함수 호출
		            });
					
					$("#myModal").modal();
					
				}
			});
		

		}
		
	});
	
	// 차트 생성 함수
    function createChart() {
        var ctx = $('.myChart');
        // data = 보기내용
        var data = {
            labels: [
                'Red',
                'Blue',
                'Yellow',
                'Olive',
                'Orange'
            ],
            // datasets = 선택인원
            datasets: [{
                label: 'My First Dataset',
                data: [300, 50, 100, 200, 100],
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'olive',
                    'orange'
                ],
                hoverOffset: 4
            }]
        };

        new Chart(ctx, {
            type: 'pie',
            data: data
        });
    }

	
});
</script>