<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<script src="${pageContext.request.contextPath }/resources/sweetAlertCustom/sweetAlertCustom.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<style>
.orderdetailBtn {
	cursor: pointer ;
	font-weight: 700;
	text-decoration: underline !important;
	font-size: 14px;
}
.cpBtn {
	cursor: pointer;
	font-weight: 700;
	border: 1px solid #eee;
	padding: 10px 20px;
}
.cpBtn:hover {
	background: #cbcfd4;
}
</style>
<div class="gap inner-bg">
    <div class="table-styles">
        <div class="little-heading">
            <h2 style="margin-bottom: 30px; font-family: 'GmarketSansMedium';">üì¶ Î∞∞ÏÜ°
            <c:choose>
            	<c:when test="${status eq 'c' }">
            	ÌõÑ
            	</c:when>
            	<c:otherwise>
            	Ï†Ñ
            	</c:otherwise>
            </c:choose> 
             Ï£ºÎ¨∏ ÎÇ¥Ïó≠</h2>
        </div>
        <div class="gap listbar-container">
            <div class="discount-copon list-bar">
                <div class="row">
                    <div class="col-md-4" style="margin-right: 20px;">
                        <form method="post" id="searchForm">
                            <input type="hidden" name="page" id="page" />
                            <div class="searchform-box" style="display: flex">
                                <select>
                                    <option value="orderNo" <c:if test="${searchType eq 'orderNo' }">selected</c:if>
                                        >Ï£ºÎ¨∏Î≤àÌò∏
                                    </option>
                                    <option value="userId" <c:if test="${searchType eq 'userId' }">selected</c:if>
                                        >Ï£ºÎ¨∏ÏûêÏïÑÏù¥Îîî
                                    </option>
                                </select>

                                <input type="text" name="searchWord" value="${searchWord }" placeholder="Í≤ÄÏÉâ">

                                <button type="submit">Í≤ÄÏÉâ</button>
                            </div>
                            <sec:csrfInput/>
                        </form>
                    </div>
                    <div class="col-md-3" style="display: flex; max-width: 13%; margin-right: 20px;">
			            <form id="deliveryForm" method="post" action="/goods/order/deliverycheckUpdate.do">
			            	<c:choose>
				            	<c:when test="${status eq 'c' }">
				            		<input type="hidden" name="orderDelivery" value="N">
				            		<span id="orderafterConfirm">
                                     	<button class="barBtn" style="width: 150px">ÏÑ†ÌÉùÌï≠Î™© Î∞∞ÏÜ° Ï†Ñ Ï≤òÎ¶¨</button>
                               		</span>
				            	</c:when>
				            	<c:otherwise>
				            		<input type="hidden" name="orderDelivery" value="Y">
					            	<span id="orderConfirm">
                                     	<button class="barBtn" style="width: 150px">ÏÑ†ÌÉùÌï≠Î™© Î∞∞ÏÜ° Ï≤òÎ¶¨</button>
                               		</span>
				            	</c:otherwise>
				            </c:choose> 
				            <sec:csrfInput/>
			            </form>
			        </div>
                </div>
            </div>
        </div>
        
        <div class="widget">
        	<div class="totalCount" style="margin-top: 20px; height: 40px;">
        	<c:choose>
        		<c:when test="${status eq 'c' }">
	        		<span style="font-weight: 600; color: red; padding: 20px 0px 10px 20px;">Ï¥ù Ï£ºÎ¨∏ Í±¥ : ${pagingVO.totalRecord }</span>
        		</c:when>
        		<c:otherwise>
        			<span style="font-weight: 600; color: red; padding: 20px 0px 10px 20px;">Ï¥ù Ï£ºÎ¨∏ Í±¥ : ${pagingVO.totalRecord }</span>
        		</c:otherwise>
        	</c:choose>
        	</div>
            <table class="prj-tbl striped table-responsive">
                <thead class="color">
                    <tr class="prodTitle">
                    	<th><i class="all-slct"></i></th>
                        <th><em>Î≤àÌò∏</em></th>
                        <th><em>Ïù¥ÎØ∏ÏßÄ</em></th>
                        <th><em>Ï†úÌíàÎ™Ö</em></th>
                        <th><em>ÏàòÎüâ</em></th>
                        <th><em>Í∞ÄÍ≤©(Ïõê)</em></th>
                        <th><em>Ï¥ùÏ£ºÎ¨∏Ïï°(Ïõê)</em></th>
                        <th><em>Ï£ºÎ¨∏ÏïÑÏù¥Îîî</em></th>
                        <th><em>Í≤∞Ï†úÎ∞©Î≤ï</em></th>
                        <th><em>Ï£ºÎ¨∏ÏùºÏûê</em></th>
                        <th><em>ÏÉÅÌÉú</em></th>
                    </tr>
                </thead>
                <tbody id="cancelTable">
                    <c:set value="${pagingVO.dataList }" var="deliveryList" />
                    <c:choose>
                        <c:when test="${empty deliveryList}">
                            <tr>
                                <td colspan="12">ÏÉÅÌíà Î¶¨Ïä§Ìä∏Í∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.</td>
                            </tr>
                        </c:when>
                        <c:otherwise>
                            <c:forEach items="${deliveryList }" var="delivery" varStatus="vs1">
                                <c:forEach items="${delivery.orderDetailList }" var="deliveryDetail" varStatus="vs2">
                                    <tr class="cancelList">
                                        <c:if test="${vs2.index eq 0 }">
	                                    	<td rowspan="${fn:length(delivery.orderDetailList) }"><i class="sngl-slct" data-index="${vs1.index}"></i></td>
                                            <td rowspan="${fn:length(delivery.orderDetailList) }"> 
                                                <a class="orderdetailBtn" data-index="${vs1.index}">${delivery.orderNo }</a>
                                            </td>
                                        </c:if>

                                        <td>
                                            <img alt="" src="${deliveryDetail.goodsThumbnail }" style="width:40px;">
                                        </td>
                                        <td style="text-align: left">
                                            <a class="goodsBtn" data-prodNo="${deliveryDetail.goodsNo }">
                                                <span>${deliveryDetail.goodsName }</span>
                                            </a>
                                        </td>
                                        <td><span><fmt:formatNumber value="${deliveryDetail.odQuantity }" pattern="#,###"/></span></td>
                                        <td><span><fmt:formatNumber value="${deliveryDetail.odTotalprice }" pattern="#,###"/></span></td>

                                        <c:if test="${vs2.index eq 0 }">
                                            <td rowspan="${fn:length(delivery.orderDetailList) }">
                                                <span><fmt:formatNumber value="${delivery.orderTotalprice}" pattern="#,###"/></span></td>
                                            <td rowspan="${fn:length(delivery.orderDetailList) }">
                                                <span>${delivery.userId }</span>
                                            </td>
                                            <td rowspan="${fn:length(delivery.orderDetailList) }">
                                                <span>${delivery.orderPay }</span>
                                            </td>
                                            <td rowspan="${fn:length(delivery.orderDetailList) }">
                                                <fmt:parseDate value="${delivery.orderDate}" var="orderDate"
                                                    pattern="yyyy-MM-dd" />
                                                <span>
                                                    <fmt:formatDate value="${orderDate}" pattern="yyyy-MM-dd" />
                                                </span>
                                            </td>
                                            <td rowspan="${fn:length(delivery.orderDetailList) }">
                                            	<c:choose>
									            	<c:when test="${status eq 'c' }">
									            		
									            		<span>
	                                                    	<a type="button" class="cpBtn" data-index="${vs1.index}">Î∞∞ÏÜ° Ï†Ñ Ï≤òÎ¶¨</a>
	                                              		</span>
									            	</c:when>
									            	<c:otherwise>
										            	<span>
	                                                    	<a type="button" class="cpBtn" data-index="${vs1.index}">Î∞∞ÏÜ° Ï≤òÎ¶¨</a>
	                                              		</span>
									            	</c:otherwise>
									            </c:choose> 
                                            </td>
                                        </c:if>
                                    </tr>
                                </c:forEach>
                            </c:forEach>
                        </c:otherwise>
                    </c:choose>
                </tbody>
            </table>
        </div>
        <div class="card-footer prod-footer clearfix" id="pagingArea">
            ${pagingVO.pagingHTML }
        </div>
    </div>
</div>


<script src="${pageContext.request.contextPath }/resources/js1/bootstrap.min.js"></script>
<script>
$(function () {
	var orderNos = [];
	var snglSlct = $(".sngl-slct");
	
	snglSlct.on("click", function () {
		$(this).toggleClass('active'); 
		
		var index = $(this).data("index");
		var orderNo = $(".orderdetailBtn").eq(index).text();
		
	    if (orderNos.indexOf(orderNo) === -1) {
	        // Ï§ëÎ≥µÎêú Í∞íÏù¥ ÏóÜÎäî Í≤ΩÏö∞ÏóêÎßå Î∞∞Ïó¥Ïóê Ï∂îÍ∞Ä
	        orderNos.push(orderNo);
	    } else {
	        // Ï§ëÎ≥µÎêú Í∞íÏù¥ ÏûàÎäî Í≤ΩÏö∞, Ìï¥Îãπ Í∞í ÏÇ≠Ï†ú
	        orderNos = orderNos.filter(function(value) {
	            return value !== orderNo;
	        });
	    }		
		console.log("ÌòÑÏû¨ orderNos Î∞∞Ïó¥ : ", orderNos);
	});
	
	var deliveryForm = $("#deliveryForm");
	var barBtn = $(".barBtn");
	
	barBtn.on("click", function (event) {
		event.preventDefault();
		var buttonText = $(this).text();
		
		if (buttonText == "ÏÑ†ÌÉùÌï≠Î™© Î∞∞ÏÜ° Ï≤òÎ¶¨") {
			console.log($("#orderNos").val(orderNos));
			Swal.fire({
		        title: 'ÏÑ†ÌÉùÌï≠Î™©ÏùÑ Î∞∞ÏÜ°Ï≤òÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?', 
		        text: " ", 
		        icon: 'warning', 
		        showCancelButton: true, // Ï∑®ÏÜå Î≤ÑÌäº Î≥¥Ïù¥ÎèÑÎ°ù ÏÑ§Ï†ï
		        confirmButtonColor: '#3085d6', // ÏÇ≠Ï†ú Î≤ÑÌäº ÏÉâÏÉÅ ÏÑ§Ï†ï
		        cancelButtonColor: '#d33', // Ï∑®ÏÜå Î≤ÑÌäº ÏÉâÏÉÅ ÏÑ§Ï†ï
		        confirmButtonText: 'Î∞∞ÏÜ° Ï≤òÎ¶¨', // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
		        cancelButtonText: 'Ï∑®ÏÜå' // Ï∑®ÏÜå Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
		    }).then((result) => {
		        setTimeout(() => {
		            Swal.close(); // ÏùºÏ†ï ÏãúÍ∞Ñ ÌõÑ SweetAlert2 Í≤ΩÍ≥†Ï∞Ω Îã´Í∏∞
		        }, 2000); // 2000ms(2Ï¥à) ÌõÑÏóê Í≤ΩÍ≥†Ï∞Ω Îã´Í∏∞
		        if (result.isConfirmed) { 
		        	// ÏÇ≠Ï†ú Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå
		   			for (var i = 0; i < orderNos.length; i++) {
						$("#orderConfirm").append('<input type="hidden" name="orderNos" value="' + orderNos[i] + '">');
					}
					deliveryForm.submit();
		            Swal.fire( 
		                'Î∞∞ÏÜ°Ï≤òÎ¶¨ ÏÑ±Í≥µ!', 
		                '', 
		                'success' 
		            )
		        } else if (result.dismiss === Swal.DismissReason.cancel) { // Ï∑®ÏÜå Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå
		            // "Ï∑®ÏÜå" Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå
		            Swal.fire( 
		                'ÏûëÏóÖÏù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 
		                '', 
		                'info' 
		            )
		        }
		    });
		}else{
			Swal.fire({
		        title: 'ÏÑ†ÌÉùÌï≠Î™©ÏùÑ Î∞∞ÏÜ° Ï†Ñ Ï≤òÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?', 
		        text: " ", 
		        icon: 'warning', 
		        showCancelButton: true, // Ï∑®ÏÜå Î≤ÑÌäº Î≥¥Ïù¥ÎèÑÎ°ù ÏÑ§Ï†ï
		        confirmButtonColor: '#3085d6', // ÏÇ≠Ï†ú Î≤ÑÌäº ÏÉâÏÉÅ ÏÑ§Ï†ï
		        cancelButtonColor: '#d33', // Ï∑®ÏÜå Î≤ÑÌäº ÏÉâÏÉÅ ÏÑ§Ï†ï
		        confirmButtonText: 'Î∞∞ÏÜ° Ï†Ñ Ï≤òÎ¶¨', // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
		        cancelButtonText: 'Ï∑®ÏÜå' // Ï∑®ÏÜå Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
		    }).then((result) => {
		        setTimeout(() => {
		            Swal.close(); // ÏùºÏ†ï ÏãúÍ∞Ñ ÌõÑ SweetAlert2 Í≤ΩÍ≥†Ï∞Ω Îã´Í∏∞
		        }, 2000); // 2000ms(2Ï¥à) ÌõÑÏóê Í≤ΩÍ≥†Ï∞Ω Îã´Í∏∞
		        if (result.isConfirmed) { 
		        	// ÏÇ≠Ï†ú Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå
		   			for (var i = 0; i < orderNos.length; i++) {
						$("#orderafterConfirm").append('<input type="hidden" name="orderNos" value="' + orderNos[i] + '">');
					}
					deliveryForm.submit();
		            Swal.fire( 
		                'Î∞∞ÏÜ° Ï†Ñ Ï≤òÎ¶¨ ÏÑ±Í≥µ!', 
		                '', 
		                'success' 
		            )
		        } else if (result.dismiss === Swal.DismissReason.cancel) { // Ï∑®ÏÜå Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå
		            // "Ï∑®ÏÜå" Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå
		            Swal.fire( 
		                'ÏûëÏóÖÏù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 
		                '', 
		                'info' 
		            )
		        }
		    });
		}	
	});

	
	var cpBtn = $(".cpBtn");

	cpBtn.on("click", function () {
		if (cpBtn.eq(0).text() == "Î∞∞ÏÜ° Ï≤òÎ¶¨") {
			Swal.fire({
	            title: 'Î∞∞ÏÜ° ÏôÑÎ£å Ï≤òÎ¶¨ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
	            text: " ",
	            icon: 'warning',
	            showCancelButton: true,
	            confirmButtonColor: '#3085d6',
	            cancelButtonColor: '#d33',
	            confirmButtonText: 'Î∞∞ÏÜ°Ï≤òÎ¶¨ ÌïòÍ∏∞',
	            cancelButtonText: 'Ï∑®ÏÜå'
	        }).then((result) => {
	        	if (result.isConfirmed) {
	        		var index = $(this).data("index");
	        		var orderNo = $(".orderdetailBtn").eq(index).text();

	                $.ajax({
	                    url: "/goods/order/deliveryUpdate.do",
	                    method: 'POST',
	                    data : {orderNo : orderNo, orderDelivery : 'Y'},
	                    beforeSend: function(xhr){
	                    	xhr.setRequestHeader(header, token);
	                    },
	                    success: function(data) {
	                        Swal.fire(
	                            'Î∞∞ÏÜ°Ï≤òÎ¶¨ ÏôÑÎ£å!',
	                            'ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞ÏÜ°Ï≤òÎ¶¨ ÎêòÏóàÏäµÎãàÎã§.',
	                            'success'
	                        ).then(() => {
	                        	location.href = "/goods/order/adminDeliveryBeforeList.do";
	                        	
	                        });
	                    },
	                    error: function(xhr, status, error) {
	                        Swal.fire(
	                            'Ï≤òÎ¶¨ Ïã§Ìå®!',
	                            'Ï≤òÎ¶¨ ÎèÑÏ§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.',
	                            'error'
	                        );
	                    }
	                });
	            }
	
	        });
		}else {
			Swal.fire({
	            title: 'Î∞∞ÏÜ° Ï†Ñ Ï≤òÎ¶¨ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
	            text: " ",
	            icon: 'warning',
	            showCancelButton: true,
	            confirmButtonColor: '#3085d6',
	            cancelButtonColor: '#d33',
	            confirmButtonText: 'Î∞∞ÏÜ° Ï†Ñ Ï≤òÎ¶¨ ÌïòÍ∏∞',
	            cancelButtonText: 'Ï∑®ÏÜå'
	        }).then((result) => {
	        	if (result.isConfirmed) {
	        		var index = $(this).data("index");
	        		var orderNo = $(".orderdetailBtn").eq(index).text();

	                $.ajax({
	                    url: "/goods/order/deliveryUpdate.do",
	                    method: 'POST',
	                    data : {orderNo : orderNo, orderDelivery : 'N'},
	                    beforeSend: function(xhr){
	                    	xhr.setRequestHeader(header, token);
	                    },
	                    success: function(data) {
	                        Swal.fire(
	                            'Î∞∞ÏÜ° Ï†Ñ Ï≤òÎ¶¨ ÏôÑÎ£å!',
	                            'ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞ÏÜ° Ï†Ñ Ï≤òÎ¶¨ ÎêòÏóàÏäµÎãàÎã§.',
	                            'success'
	                        ).then(() => {
	                        	location.href = "/goods/order/adminDeliveryAfterList.do";
	                        	
	                        });
	                    },
	                    error: function(xhr, status, error) {
	                        Swal.fire(
	                            'Ï≤òÎ¶¨ Ïã§Ìå®!',
	                            'Ï≤òÎ¶¨ ÎèÑÏ§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.',
	                            'error'
	                        );
	                    }
	                });
	            }
	
	        });
		}
	})
	
	var orderdetailBtn = $(".orderdetailBtn");
	
	orderdetailBtn.on("click", function () {
		var orderNo = $(this).text();
		location.href = "/goods/order/deliveryDetail.do?orderNo=" + orderNo;
	});
	
	
	//ÌéòÏù¥Ïßï Î∂ÄÎ∂Ñ
	var searchForm = $("#searchForm")
	var pagingArea = $("#pagingArea");
	
	pagingArea.on("click", "a", function (event) {
		event.preventDefault();
		var pageNo = $(this).data("page");
		searchForm.find("#page").val(pageNo);
		
		if ($("#bs2").hasClass("active")) {
			searchForm.append("<input type='hidden' name='odstatus' id='odstatus' value='2'/>");
			searchForm.submit();
		}
		searchForm.submit();
	});
	
	$('.all-slct').on("click",function(){
		$(this).toggleClass('active');
	    $(".sngl-slct").toggleClass('active'); 
	});
});
</script>