<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<script src="${pageContext.request.contextPath }/resources/sweetAlertCustom/sweetAlertCustom.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<style>
.orderdetailBtn {
	cursor: pointer ;
	font-weight: 700;
	text-decoration: underline !important;
	font-size: 14px;
}
.cpBtn {
	cursor: pointer;
	font-weight: 700;
	border: 1px solid #eee;
	padding: 10px 20px;
}
.cpBtn:hover {
	background: #cbcfd4;
}
</style>
<div class="gap inner-bg">
    <div class="table-styles">
        <div class="little-heading">
            <h2 style="margin-bottom: 30px; font-family: 'GmarketSansMedium';">ğŸ“¦ ë°°ì†¡
            <c:choose>
            	<c:when test="${status eq 'c' }">
            	í›„
            	</c:when>
            	<c:otherwise>
            	ì „
            	</c:otherwise>
            </c:choose> 
             ì£¼ë¬¸ ë‚´ì—­</h2>
        </div>
        <div class="gap listbar-container">
            <div class="discount-copon list-bar">
                <div class="row">
                    <div class="col-md-4" style="margin-right: 20px;">
                        <form method="post" id="searchForm">
                            <input type="hidden" name="page" id="page" />
                            <div class="searchform-box" style="display: flex">
                                <select>
                                    <option value="orderNo" <c:if test="${searchType eq 'orderNo' }">selected</c:if>
                                        >ì£¼ë¬¸ë²ˆí˜¸
                                    </option>
                                    <option value="userId" <c:if test="${searchType eq 'userId' }">selected</c:if>
                                        >ì£¼ë¬¸ìì•„ì´ë””
                                    </option>
                                </select>

                                <input type="text" name="searchWord" value="${searchWord }" placeholder="ê²€ìƒ‰">

                                <button type="submit">ê²€ìƒ‰</button>
                            </div>
                            <sec:csrfInput/>
                        </form>
                    </div>
                    <div class="col-md-3" style="display: flex; max-width: 13%; margin-right: 20px;">
			            <form id="deliveryForm" method="post" action="/goods/order/deliverycheckUpdate.do">
			            	<c:choose>
				            	<c:when test="${status eq 'c' }">
				            		<input type="hidden" name="orderDelivery" value="N">
				            		<span id="orderafterConfirm">
                                     	<button class="barBtn" style="width: 150px">ì„ íƒí•­ëª© ë°°ì†¡ ì „ ì²˜ë¦¬</button>
                               		</span>
				            	</c:when>
				            	<c:otherwise>
				            		<input type="hidden" name="orderDelivery" value="Y">
					            	<span id="orderConfirm">
                                     	<button class="barBtn" style="width: 150px">ì„ íƒí•­ëª© ë°°ì†¡ ì²˜ë¦¬</button>
                               		</span>
				            	</c:otherwise>
				            </c:choose> 
				            <sec:csrfInput/>
			            </form>
			        </div>
                </div>
            </div>
        </div>
        
        <div class="widget">
        	<div class="totalCount" style="margin-top: 20px; height: 40px;">
        	<c:choose>
        		<c:when test="${status eq 'c' }">
	        		<span style="font-weight: 600; color: red; padding: 20px 0px 10px 20px;">ì´ ì£¼ë¬¸ ê±´ : ${pagingVO.totalRecord }</span>
        		</c:when>
        		<c:otherwise>
        			<span style="font-weight: 600; color: red; padding: 20px 0px 10px 20px;">ì´ ì£¼ë¬¸ ê±´ : ${pagingVO.totalRecord }</span>
        		</c:otherwise>
        	</c:choose>
        	</div>
            <table class="prj-tbl striped table-responsive">
                <thead class="color">
                    <tr class="prodTitle">
                    	<th><i class="all-slct"></i></th>
                        <th><em>ë²ˆí˜¸</em></th>
                        <th><em>ì´ë¯¸ì§€</em></th>
                        <th><em>ì œí’ˆëª…</em></th>
                        <th><em>ìˆ˜ëŸ‰</em></th>
                        <th><em>ê°€ê²©(ì›)</em></th>
                        <th><em>ì´ì£¼ë¬¸ì•¡(ì›)</em></th>
                        <th><em>ì£¼ë¬¸ì•„ì´ë””</em></th>
                        <th><em>ê²°ì œë°©ë²•</em></th>
                        <th><em>ì£¼ë¬¸ì¼ì</em></th>
                        <th><em>ìƒíƒœ</em></th>
                    </tr>
                </thead>
                <tbody id="cancelTable">
                    <c:set value="${pagingVO.dataList }" var="deliveryList" />
                    <c:choose>
                        <c:when test="${empty deliveryList}">
                            <tr>
                                <td colspan="12">ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</td>
                            </tr>
                        </c:when>
                        <c:otherwise>
                            <c:forEach items="${deliveryList }" var="delivery" varStatus="vs1">
                                <c:forEach items="${delivery.orderDetailList }" var="deliveryDetail" varStatus="vs2">
                                    <tr class="cancelList">
                                        <c:if test="${vs2.index eq 0 }">
	                                    	<td rowspan="${fn:length(delivery.orderDetailList) }"><i class="sngl-slct" data-index="${vs1.index}"></i></td>
                                            <td rowspan="${fn:length(delivery.orderDetailList) }"> 
                                                <a class="orderdetailBtn" data-index="${vs1.index}">${delivery.orderNo }</a>
                                            </td>
                                        </c:if>

                                        <td>
                                            <img alt="" src="${deliveryDetail.goodsThumbnail }" style="width:40px;">
                                        </td>
                                        <td style="text-align: left">
                                            <a class="goodsBtn" data-prodNo="${deliveryDetail.goodsNo }">
                                                <span>${deliveryDetail.goodsName }</span>
                                            </a>
                                        </td>
                                        <td><span><fmt:formatNumber value="${deliveryDetail.odQuantity }" pattern="#,###"/></span></td>
                                        <td><span><fmt:formatNumber value="${deliveryDetail.odTotalprice }" pattern="#,###"/></span></td>

                                        <c:if test="${vs2.index eq 0 }">
                                            <td rowspan="${fn:length(delivery.orderDetailList) }">
                                                <span><fmt:formatNumber value="${delivery.orderTotalprice}" pattern="#,###"/></span></td>
                                            <td rowspan="${fn:length(delivery.orderDetailList) }">
                                                <span>${delivery.userId }</span>
                                            </td>
                                            <td rowspan="${fn:length(delivery.orderDetailList) }">
                                                <span>${delivery.orderPay }</span>
                                            </td>
                                            <td rowspan="${fn:length(delivery.orderDetailList) }">
                                                <fmt:parseDate value="${delivery.orderDate}" var="orderDate"
                                                    pattern="yyyy-MM-dd" />
                                                <span>
                                                    <fmt:formatDate value="${orderDate}" pattern="yyyy-MM-dd" />
                                                </span>
                                            </td>
                                            <td rowspan="${fn:length(delivery.orderDetailList) }">
                                            	<c:choose>
									            	<c:when test="${status eq 'c' }">
									            		
									            		<span>
	                                                    	<a type="button" class="cpBtn" data-index="${vs1.index}">ë°°ì†¡ ì „ ì²˜ë¦¬</a>
	                                              		</span>
									            	</c:when>
									            	<c:otherwise>
										            	<span>
	                                                    	<a type="button" class="cpBtn" data-index="${vs1.index}">ë°°ì†¡ ì²˜ë¦¬</a>
	                                              		</span>
									            	</c:otherwise>
									            </c:choose> 
                                            </td>
                                        </c:if>
                                    </tr>
                                </c:forEach>
                            </c:forEach>
                        </c:otherwise>
                    </c:choose>
                </tbody>
            </table>
        </div>
        <div class="card-footer prod-footer clearfix" id="pagingArea">
            ${pagingVO.pagingHTML }
        </div>
    </div>
</div>


<script src="${pageContext.request.contextPath }/resources/js1/bootstrap.min.js"></script>
<script>
$(function () {
	var orderNos = [];
	var snglSlct = $(".sngl-slct");
	
	snglSlct.on("click", function () {
		$(this).toggleClass('active'); 
		
		var index = $(this).data("index");
		var orderNo = $(".orderdetailBtn").eq(index).text();
		
	    if (orderNos.indexOf(orderNo) === -1) {
	        // ì¤‘ë³µëœ ê°’ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ ë°°ì—´ì— ì¶”ê°€
	        orderNos.push(orderNo);
	    } else {
	        // ì¤‘ë³µëœ ê°’ì´ ìˆëŠ” ê²½ìš°, í•´ë‹¹ ê°’ ì‚­ì œ
	        orderNos = orderNos.filter(function(value) {
	            return value !== orderNo;
	        });
	    }		
		console.log("í˜„ì¬ orderNos ë°°ì—´ : ", orderNos);
	});
	
	var deliveryForm = $("#deliveryForm");
	var barBtn = $(".barBtn");
	
	barBtn.on("click", function (event) {
		event.preventDefault();
		var buttonText = $(this).text();
		
		if (buttonText == "ì„ íƒí•­ëª© ë°°ì†¡ ì²˜ë¦¬") {
			console.log($("#orderNos").val(orderNos));
			Swal.fire({
		        title: 'ì„ íƒí•­ëª©ì„ ë°°ì†¡ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 
		        text: " ", 
		        icon: 'warning', 
		        showCancelButton: true, // ì·¨ì†Œ ë²„íŠ¼ ë³´ì´ë„ë¡ ì„¤ì •
		        confirmButtonColor: '#3085d6', // ì‚­ì œ ë²„íŠ¼ ìƒ‰ìƒ ì„¤ì •
		        cancelButtonColor: '#d33', // ì·¨ì†Œ ë²„íŠ¼ ìƒ‰ìƒ ì„¤ì •
		        confirmButtonText: 'ë°°ì†¡ ì²˜ë¦¬', // ì‚­ì œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
		        cancelButtonText: 'ì·¨ì†Œ' // ì·¨ì†Œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
		    }).then((result) => {
		        setTimeout(() => {
		            Swal.close(); // ì¼ì • ì‹œê°„ í›„ SweetAlert2 ê²½ê³ ì°½ ë‹«ê¸°
		        }, 2000); // 2000ms(2ì´ˆ) í›„ì— ê²½ê³ ì°½ ë‹«ê¸°
		        if (result.isConfirmed) { 
		        	// ì‚­ì œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
		   			for (var i = 0; i < orderNos.length; i++) {
						$("#orderConfirm").append('<input type="hidden" name="orderNos" value="' + orderNos[i] + '">');
					}
					deliveryForm.submit();
		            Swal.fire( 
		                'ë°°ì†¡ì²˜ë¦¬ ì„±ê³µ!', 
		                '', 
		                'success' 
		            )
		        } else if (result.dismiss === Swal.DismissReason.cancel) { // ì·¨ì†Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
		            // "ì·¨ì†Œ" ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
		            Swal.fire( 
		                'ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 
		                '', 
		                'info' 
		            )
		        }
		    });
		}else{
			Swal.fire({
		        title: 'ì„ íƒí•­ëª©ì„ ë°°ì†¡ ì „ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 
		        text: " ", 
		        icon: 'warning', 
		        showCancelButton: true, // ì·¨ì†Œ ë²„íŠ¼ ë³´ì´ë„ë¡ ì„¤ì •
		        confirmButtonColor: '#3085d6', // ì‚­ì œ ë²„íŠ¼ ìƒ‰ìƒ ì„¤ì •
		        cancelButtonColor: '#d33', // ì·¨ì†Œ ë²„íŠ¼ ìƒ‰ìƒ ì„¤ì •
		        confirmButtonText: 'ë°°ì†¡ ì „ ì²˜ë¦¬', // ì‚­ì œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
		        cancelButtonText: 'ì·¨ì†Œ' // ì·¨ì†Œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
		    }).then((result) => {
		        setTimeout(() => {
		            Swal.close(); // ì¼ì • ì‹œê°„ í›„ SweetAlert2 ê²½ê³ ì°½ ë‹«ê¸°
		        }, 2000); // 2000ms(2ì´ˆ) í›„ì— ê²½ê³ ì°½ ë‹«ê¸°
		        if (result.isConfirmed) { 
		        	// ì‚­ì œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
		   			for (var i = 0; i < orderNos.length; i++) {
						$("#orderafterConfirm").append('<input type="hidden" name="orderNos" value="' + orderNos[i] + '">');
					}
					deliveryForm.submit();
		            Swal.fire( 
		                'ë°°ì†¡ ì „ ì²˜ë¦¬ ì„±ê³µ!', 
		                '', 
		                'success' 
		            )
		        } else if (result.dismiss === Swal.DismissReason.cancel) { // ì·¨ì†Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
		            // "ì·¨ì†Œ" ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
		            Swal.fire( 
		                'ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 
		                '', 
		                'info' 
		            )
		        }
		    });
		}	
	});

	
	var cpBtn = $(".cpBtn");

	cpBtn.on("click", function () {
		if (cpBtn.eq(0).text() == "ë°°ì†¡ ì²˜ë¦¬") {
			Swal.fire({
	            title: 'ë°°ì†¡ ì™„ë£Œ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
	            text: " ",
	            icon: 'warning',
	            showCancelButton: true,
	            confirmButtonColor: '#3085d6',
	            cancelButtonColor: '#d33',
	            confirmButtonText: 'ë°°ì†¡ì²˜ë¦¬ í•˜ê¸°',
	            cancelButtonText: 'ì·¨ì†Œ'
	        }).then((result) => {
	        	if (result.isConfirmed) {
	        		var index = $(this).data("index");
	        		var orderNo = $(".orderdetailBtn").eq(index).text();

	                $.ajax({
	                    url: "/goods/order/deliveryUpdate.do",
	                    method: 'POST',
	                    data : {orderNo : orderNo, orderDelivery : 'Y'},
	                    beforeSend: function(xhr){
	                    	xhr.setRequestHeader(header, token);
	                    },
	                    success: function(data) {
	                        Swal.fire(
	                            'ë°°ì†¡ì²˜ë¦¬ ì™„ë£Œ!',
	                            'ì„±ê³µì ìœ¼ë¡œ ë°°ì†¡ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.',
	                            'success'
	                        ).then(() => {
	                        	location.href = "/goods/order/adminDeliveryBeforeList.do";
	                        	
	                        });
	                    },
	                    error: function(xhr, status, error) {
	                        Swal.fire(
	                            'ì²˜ë¦¬ ì‹¤íŒ¨!',
	                            'ì²˜ë¦¬ ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
	                            'error'
	                        );
	                    }
	                });
	            }
	
	        });
		}else {
			Swal.fire({
	            title: 'ë°°ì†¡ ì „ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
	            text: " ",
	            icon: 'warning',
	            showCancelButton: true,
	            confirmButtonColor: '#3085d6',
	            cancelButtonColor: '#d33',
	            confirmButtonText: 'ë°°ì†¡ ì „ ì²˜ë¦¬ í•˜ê¸°',
	            cancelButtonText: 'ì·¨ì†Œ'
	        }).then((result) => {
	        	if (result.isConfirmed) {
	        		var index = $(this).data("index");
	        		var orderNo = $(".orderdetailBtn").eq(index).text();

	                $.ajax({
	                    url: "/goods/order/deliveryUpdate.do",
	                    method: 'POST',
	                    data : {orderNo : orderNo, orderDelivery : 'N'},
	                    beforeSend: function(xhr){
	                    	xhr.setRequestHeader(header, token);
	                    },
	                    success: function(data) {
	                        Swal.fire(
	                            'ë°°ì†¡ ì „ ì²˜ë¦¬ ì™„ë£Œ!',
	                            'ì„±ê³µì ìœ¼ë¡œ ë°°ì†¡ ì „ ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.',
	                            'success'
	                        ).then(() => {
	                        	location.href = "/goods/order/adminDeliveryAfterList.do";
	                        	
	                        });
	                    },
	                    error: function(xhr, status, error) {
	                        Swal.fire(
	                            'ì²˜ë¦¬ ì‹¤íŒ¨!',
	                            'ì²˜ë¦¬ ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
	                            'error'
	                        );
	                    }
	                });
	            }
	
	        });
		}
	})
	
	var orderdetailBtn = $(".orderdetailBtn");
	
	orderdetailBtn.on("click", function () {
		var orderNo = $(this).text();
		location.href = "/goods/order/deliveryDetail.do?orderNo=" + orderNo;
	});
	
	
	//í˜ì´ì§• ë¶€ë¶„
	var searchForm = $("#searchForm")
	var pagingArea = $("#pagingArea");
	
	pagingArea.on("click", "a", function (event) {
		event.preventDefault();
		var pageNo = $(this).data("page");
		searchForm.find("#page").val(pageNo);
		
		if ($("#bs2").hasClass("active")) {
			searchForm.append("<input type='hidden' name='odstatus' id='odstatus' value='2'/>");
			searchForm.submit();
		}
		searchForm.submit();
	});
	
	$('.all-slct').on("click",function(){
		$(this).toggleClass('active');
	    $(".sngl-slct").toggleClass('active'); 
	});
});
</script>